"use client";
import React, { useEffect, useMemo, useState } from "react";
import Nav from "@/app/components/nav";
type InvoiceRow = { id: number; billno: number | null; challanno: number | null; created_at: string; Description: any; status?: boolean; };
const InvoiceInqueryPage = () => { const [billQuery, setBillQuery] = useState(''); const [challanQuery, setChallanQuery] = useState(''); const [results, setResults] = useState<InvoiceRow[]>([]); const [loading, setLoading] = useState(false); const [error, setError] = useState<string | null>(null); const [pendingIds, setPendingIds] = useState<Set<number>>(new Set()); const qs = useMemo(()=>{ const params = new URLSearchParams(); if (billQuery.trim()) params.set('bill', billQuery.trim()); if (challanQuery.trim()) params.set('challan', challanQuery.trim()); params.set('limit','50'); return params.toString(); }, [billQuery, challanQuery]); useEffect(()=>{ const controller = new AbortController(); const id = setTimeout(async()=>{ try { setLoading(true); setError(null); const res = await fetch(`/api/invoice?${qs}`, { signal: controller.signal }); if(!res.ok) throw new Error(`HTTP ${res.status}`); const data = await res.json(); setResults(Array.isArray(data)?data:[]); } catch(e:any){ if(e?.name !== 'AbortError') setError(e?.message || 'Failed to load invoices'); } finally { setLoading(false); } },250); return ()=>{ controller.abort(); clearTimeout(id); }; },[qs]); const togglePaid = async (row:InvoiceRow) => { if(!row?.id) return; const next = !Boolean(row.status); setPendingIds(prev=> new Set(prev).add(row.id)); try { const res = await fetch('/api/invoice',{ method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ id: row.id, status: next }) }); if(!res.ok) throw new Error(`HTTP ${res.status}`); const updated = await res.json(); setResults(prev => prev.map(r => r.id===row.id ? { ...r, status: updated?.status ?? next } : r)); } catch(e) {} finally { setPendingIds(prev=>{ const n=new Set(prev); n.delete(row.id); return n; }); } }; const renderLines = (desc:any) => { const arr: any[] = Array.isArray(desc) ? desc : (desc ? [desc] : []); if(arr.length===0) return <div className='text-xs text-gray-500'>No items</div>; return (<div className='w-full min-w-0'><div className='grid grid-cols-12 bg-[var(--accent)] text-white text-[11px] uppercase rounded-t-md min-w-0'><div className='col-span-2 px-3 py-2'>QTY</div><div className='col-span-8 px-3 py-2'>Description</div><div className='col-span-2 px-3 py-2'>Amount</div></div><div className='border border-[var(--accent)] border-t-0 rounded-b-md overflow-hidden'>{arr.map((d,i)=>(<div key={i} className='grid grid-cols-12 bg-black/80 text-white text-xs border-t border-white/10'><div className='col-span-2 px-3 py-2'>{String(d?.qty ?? d?.quantity ?? '')}</div><div className='col-span-8 px-3 py-2 break-words whitespace-normal'>{String(d?.description ?? d?.materialDescription ?? '')}</div><div className='col-span-2 px-3 py-2'>{String(d?.amount ?? '')}</div></div>))}</div></div>); }; return (<div className='flex min-h-screen w-full items-start gap-5 lg:gap-7 p-4 lg:p-6 overflow-hidden'><div className='flex-1 min-w-0'><div className='rounded-xl bg-black p-4 lg:p-6 shadow text-white'><div className='mb-4'><Nav href1='/Bill' name1='Generate' href2='/Bill/inquery' name2='Inquery' /></div><h1 className='text-base lg:text-lg font-semibold mb-3'>Invoice Inquiry</h1><div className='flex flex-wrap items-end gap-4'><div><label className='block text-[11px] font-medium text-white'>Bill Number</label><input type='text' value={billQuery} onChange={e=>setBillQuery(e.target.value)} className='mt-1 w-40 text-xs border-b-2 border-[var(--accent)] focus:outline-none bg-transparent text-white placeholder:text-white/60' placeholder='e.g. 12 or 00012' /></div><div><label className='block text-[11px] font-medium text-white'>Challan Number</label><input type='text' value={challanQuery} onChange={e=>setChallanQuery(e.target.value)} className='mt-1 w-40 text-xs border-b-2 border-[var(--accent)] focus:outline-none bg-transparent text-white placeholder:text-white/60' placeholder='e.g. 34 or 00034' /></div></div><div className='mt-4 text-xs text-white/70'>{loading ? 'Loading...' : error ? `Error: ${error}` : `${results.length} result(s)`}</div><div className='mt-4 overflow-auto rounded-xl border border-white/10 h-[70vh] max-h-[70vh] bg-black p-2'><div className='hidden md:grid grid-cols-12 bg-[var(--accent)] text-white text-xs rounded-md mb-2'><div className='col-span-2 px-2 py-2'>Bill no</div><div className='col-span-2 px-2 py-2'>Challan no</div><div className='col-span-2 px-2 py-2'>Date</div><div className='col-span-5 px-2 py-2'>Description</div><div className='col-span-1 px-2 py-2 text-center'>Action</div></div><div className='space-y-4'>{results.map(row=>{ const billStr = row.billno != null ? String(row.billno).padStart(5,'0') : '-'; const challanStr = row.challanno != null ? String(row.challanno).padStart(5,'0') : '-'; const created = new Date(row.created_at).toLocaleString(); return (<div key={row.id} className='rounded-xl border border-[var(--accent)] overflow-hidden mb-4 bg-black'><div className='grid grid-cols-12 gap-2 items-start text-white p-3'><div className='col-span-12 md:col-span-2 px-2'><div className='text-[11px] uppercase text-white/60'>Bill no</div><div className='text-sm font-semibold'>{billStr}</div></div><div className='col-span-12 md:col-span-2 px-2'><div className='text-[11px] uppercase text-white/60'>Challan no</div><div className='text-sm font-semibold'>{challanStr}</div></div><div className='col-span-12 md:col-span-2 px-2'><div className='text-[11px] uppercase text-white/60'>Date</div><div className='text-sm font-semibold whitespace-nowrap'>{created}</div></div><div className='col-span-12 md:col-span-5 min-w-0'>{renderLines(row.Description)}</div><div className='col-span-12 md:col-span-1 flex md:flex-col items-stretch md:items-end gap-2'><button onClick={()=>togglePaid(row)} disabled={pendingIds.has(row.id)} className={`${row.status ? 'bg-green-500' : 'bg-[var(--accent)]'} px-4 py-1.5 rounded-md text-black text-xs font-semibold w-full md:w-auto disabled:opacity-60 disabled:cursor-not-allowed`} aria-pressed={row.status ? true : false} title={row.status ? 'Paid (click to mark Unpaid)' : 'Unpaid (click to mark Paid)'}>{row.status ? 'Paid' : 'Unpaid'}</button><button className='px-4 py-1.5 rounded-md bg-[var(--accent)] text-black text-xs font-semibold w-full md:w-auto'>Reprint</button></div></div></div>); })}</div></div></div></div></div>);
};
export default InvoiceInqueryPage;
